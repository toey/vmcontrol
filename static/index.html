<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Control Panel</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <header>
        <h1>VM Control Panel</h1>
        <p class="subtitle">QEMU / KVM Management</p>
    </header>

    <nav id="tabs">
        <button class="tab active" data-tab="vmlist">VM List</button>
        <button class="tab" data-tab="create">Create VM</button>
        <button class="tab" data-tab="createdisk">Create Disk</button>
        <button class="tab" data-tab="listimage">List Image</button>
        <button class="tab" data-tab="mountiso">Mount ISO</button>
        <button class="tab" data-tab="livemigrate">Live Migrate</button>
        <button class="tab" data-tab="backup">Backup</button>
        <button class="tab" data-tab="metadata">Metadata</button>
    </nav>

    <main>
        <!-- VM List -->
        <div id="tab-vmlist" class="tab-panel active">
            <h2>VM List</h2>
            <div id="vm-list-table-wrap">
                <table id="vm-list-table">
                    <thead>
                        <tr>
                            <th>VM-NAME</th>
                            <th>CPU</th>
                            <th>Memory</th>
                            <th>Disk</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vm-list-body">
                        <tr><td colspan="6"><em>Loading...</em></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create VM -->
        <div id="tab-create" class="tab-panel">
            <h2 id="create-title">Create VM</h2>
            <label>VM-NAME <input type="text" id="create-vm-name" placeholder="my-vm-01"></label>
            <div class="template-row">
                <label>OS Template
                    <select id="create-os-template" onchange="applyOsTemplate()">
                        <option value="custom">Custom</option>
                        <option value="ubuntu-server">Ubuntu Server</option>
                        <option value="ubuntu-desktop">Ubuntu Desktop</option>
                        <option value="debian">Debian</option>
                        <option value="centos-rocky">CentOS / Rocky</option>
                        <option value="windows-desktop">Windows 10/11</option>
                        <option value="windows-server">Windows Server</option>
                        <option value="macos">macOS</option>
                        <option value="minimal-linux">Minimal Linux</option>
                    </select>
                </label>
                <label>Base Image
                    <select id="create-base-image" onchange="onBaseImageChange()">
                        <option value="">-- no image --</option>
                    </select>
                </label>
            </div>
            <div id="template-info" style="font-size:0.85rem;margin-bottom:0.8rem;"></div>
            <div class="form-grid">
                <fieldset>
                    <legend>CPU</legend>
                    <label>Sockets <input type="text" id="start-cpu-sockets" value="1"></label>
                    <label>Cores <input type="text" id="start-cpu-cores" value="2"></label>
                    <label>Threads <input type="text" id="start-cpu-threads" value="1"></label>
                </fieldset>
                <fieldset>
                    <legend>Memory</legend>
                    <label>Size (MB) <input type="text" id="start-memory-size" value="2048"></label>
                </fieldset>
                <fieldset>
                    <legend>Features</legend>
                    <label>Is Windows
                        <select id="start-is-windows">
                            <option value="0">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </label>
                </fieldset>
            </div>
            <fieldset>
                <legend>Network Adapters</legend>
                <div id="start-network-adapters"></div>
                <button type="button" class="btn-add" onclick="addNetworkAdapter()">+ Add Adapter</button>
            </fieldset>
            <fieldset>
                <legend>Disks</legend>
                <div id="start-disks"></div>
                <button type="button" class="btn-add" onclick="addDisk()">+ Add Disk</button>
            </fieldset>
            <div class="btn-group">
                <button class="execute-btn" id="create-submit-btn" onclick="executeCreateVm()">Create VM</button>
            </div>
        </div>

        <!-- Create Disk -->
        <div id="tab-createdisk" class="tab-panel">
            <h2>Create Disk</h2>
            <label>Disk Name <input type="text" id="createdisk-name" placeholder="my-disk-01"></label>
            <label>Size <input type="text" id="createdisk-size" value="40G"></label>
            <button class="execute-btn" onclick="executeCreateDisk()">Create Disk</button>
            <fieldset style="margin-top:16px;">
                <legend>Disk Files</legend>
                <div id="disk-file-list" style="font-size:0.9em;"></div>
            </fieldset>
        </div>

        <!-- List Image -->
        <div id="tab-listimage" class="tab-panel">
            <h2>List Images</h2>
            <label>VM-NAME <select id="listimage-smac"><option value="">-- select VM --</option></select></label>
            <button class="execute-btn" onclick="executeSimple('listimage')">List Images</button>
            <fieldset style="margin-top:16px;">
                <legend>Upload &amp; Convert Image</legend>
                <p class="form-desc">Supports: qcow2, vmdk (VMware), vdi (VirtualBox), vhdx (Hyper-V), raw, img</p>
                <input type="file" id="image-file-input" accept=".qcow2,.img,.raw,.vmdk,.vdi,.vhdx">
                <div id="image-upload-progress" style="display:none; margin-top:8px;">
                    <progress id="image-progress-bar" value="0" max="100" style="width:100%;"></progress>
                    <span id="image-progress-text"></span>
                </div>
                <button class="execute-btn" onclick="uploadImage()" style="margin-top:8px;">Upload &amp; Convert</button>
            </fieldset>
            <fieldset style="margin-top:16px;">
                <legend>Image Files</legend>
                <div id="image-file-list" style="font-size:0.9em;"></div>
            </fieldset>
        </div>

        <!-- Mount ISO -->
        <div id="tab-mountiso" class="tab-panel">
            <h2>Mount ISO</h2>
            <label>VM-NAME <select id="mountiso-smac"><option value="">-- select VM --</option></select></label>
            <label>ISO <select id="mountiso-isoname"><option value="">-- select ISO --</option></select></label>
            <div class="btn-group">
                <button class="execute-btn" onclick="executeMountIso()">Mount ISO</button>
                <button class="execute-btn btn-unmount" onclick="executeUnmountIso()">Unmount ISO</button>
            </div>
            <fieldset style="margin-top:16px;">
                <legend>Upload ISO</legend>
                <input type="file" id="iso-file-input" accept=".iso">
                <div id="iso-upload-progress" style="display:none; margin-top:8px;">
                    <progress id="iso-progress-bar" value="0" max="100" style="width:100%;"></progress>
                    <span id="iso-progress-text"></span>
                </div>
                <button class="execute-btn" onclick="uploadIso()" style="margin-top:8px;">Upload</button>
            </fieldset>
            <fieldset style="margin-top:16px;">
                <legend>ISO Files</legend>
                <div id="iso-file-list" style="font-size:0.9em;"></div>
            </fieldset>
        </div>

        <!-- Live Migrate -->
        <div id="tab-livemigrate" class="tab-panel">
            <h2>Live Migrate</h2>
            <label>VM-NAME <select id="livemigrate-smac"><option value="">-- select VM --</option></select></label>
            <label>To Node IP <input type="text" id="livemigrate-to-node-ip" placeholder="10.40.1.32"></label>
            <button class="execute-btn" onclick="executeLiveMigrate()">Live Migrate</button>
        </div>

        <!-- Backup -->
        <div id="tab-backup" class="tab-panel">
            <h2>Backup VM</h2>
            <label>VM-NAME <select id="backup-smac"><option value="">-- select VM --</option></select></label>
            <button class="execute-btn" onclick="executeBackup()">Backup VM</button>
            <fieldset style="margin-top:16px;">
                <legend>Backup History</legend>
                <div id="backup-list" style="font-size:0.9em;"></div>
            </fieldset>
        </div>
        <!-- Metadata Service (per-VM) -->
        <div id="tab-metadata" class="tab-panel">
            <h2>Metadata Service (MDS)</h2>
            <p class="form-desc">Per-VM cloud-init configuration (used for seed ISO generation)</p>
            <label>VM-NAME <select id="metadata-smac" onchange="loadMdsConfig()"><option value="">-- select VM --</option></select></label>
            <fieldset>
                <legend>Instance Identity</legend>
                <label>Instance ID <input type="text" id="mds-instance-id" placeholder="i-0000000000000001"></label>
                <label>AMI ID <input type="text" id="mds-ami-id" placeholder="ami-00000001"></label>
                <label>Hostname Prefix <input type="text" id="mds-hostname-prefix" placeholder="vm"></label>
            </fieldset>
            <fieldset>
                <legend>Network</legend>
                <label>Local IPv4 <input type="text" id="mds-local-ipv4" placeholder="10.0.1.10"></label>
                <label>VLAN <input type="text" id="mds-vlan" placeholder="0"></label>
                <label>Default MAC <input type="text" id="mds-default-mac" placeholder="52:54:00:00:00:01"></label>
            </fieldset>
            <fieldset>
                <legend>Cloud-Init</legend>
                <label>SSH Public Key <input type="text" id="mds-ssh-pubkey" placeholder="ssh-rsa AAAA..."></label>
                <label>Root Password <input type="password" id="mds-root-password" placeholder="leave empty to keep current" autocomplete="off"></label>
                <label>Extra Userdata (YAML)
                    <textarea id="mds-userdata-extra" rows="5" placeholder="# Additional cloud-init YAML"></textarea>
                </label>
            </fieldset>
            <div class="btn-group">
                <button class="execute-btn" onclick="saveMdsConfig()">Save Config</button>
            </div>
        </div>
    </main>

    <section id="output-section">
        <h3>Output</h3>
        <div id="status-indicator"></div>
        <pre id="output">Ready.</pre>
    </section>

    <script src="/app.js"></script>
</body>
</html>
